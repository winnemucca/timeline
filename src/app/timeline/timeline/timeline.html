<div class="timeline-root">
  <div class="timeline-selection">
    <h3 class="selection-description">Work Orders</h3>

    <div class="timescale-control">
      <span class="timescale-label">Timescale</span>

      <div class="timescale-select">
        <ng-select
          class="timescale-ng-select"
          [items]="['day', 'week', 'month']"
          [formControl]="timescaleControl"
          [clearable]="false"
          [searchable]="false"
        >
          <ng-template ng-label-tmp let-item="item">
            {{ item | titlecase }}
          </ng-template>

          <ng-template ng-option-tmp let-item="item">
            {{ item | titlecase }}
          </ng-template>
        </ng-select>
      </div>
    </div>
  </div>
  <!-- ================= HEADER ================= -->
  <div class="timeline-header">
    <!-- LEFT -->
    <div class="left-header">
      <span class="header-title">Work Center</span>
    </div>

    <!-- RIGHT -->
    <div class="right-header">
      <!-- MONTH HEADER -->
      @if (timescale() === 'month') {
        <div class="months-row">
          @for (month of months(); track month.label) {
            <div class="month-cell" [style.width.px]="month.span * pxPerUnit">
              {{ month.label }}
            </div>
          }
        </div>
      } @else {
        <!-- UNIT HEADER -->
        <div class="units-row">
          @for (unit of units(); track unit.getTime()) {
            <div class="unit-cell" [style.width.px]="pxPerUnit">
              {{ scale().label(unit) }}
            </div>
          }
        </div>
      }
    </div>
  </div>

  <!-- ================= BODY ================= -->
  <div class="timeline-body">
    <!-- LEFT COLUMN -->
    <div class="left-column">
      @for (wc of schedule.workCenters(); track wc.id) {
        <div class="work-center-cell">
          {{ wc.name }}
        </div>
      }
    </div>

    <!-- RIGHT GRID -->
    <div class="right-column" #rightColumn>
      <!-- TODAY -->
      @if (todayOffsetPx() !== null) {
        <div class="today-indicator" [style.left.px]="todayOffsetPx()"></div>
      }

      <!-- ROWS -->
      @for (wc of schedule.workCenters(); track wc.id) {
        <div
          class="timeline-row"
          [style.height.px]="getRowHeight(wc.id)"
          (click)="onEmptyRowClick(wc.id, $event)"
        >
          <!-- GRID -->
          <div class="grid-row">
            @for (unit of units(); track unit.getTime()) {
              <div class="grid-cell" [style.width.px]="pxPerUnit"></div>
            }
          </div>

          <!-- WORK ORDERS -->
          @for (pwo of positionedOrdersFor(wc.id)(); track pwo.order.docId) {
            <div
              class="work-order-bar"
              (click)="$event.stopImmediatePropagation()"
              [ngClass]="[
                pwo.order.status,
                activeMenuOrderId === pwo.order.docId ? 'menu-open' : '',
              ]"
              [ngStyle]="getBarStyle(pwo)"
            >
              <span class="order-name">
                {{ pwo.order.name }}
              </span>

              <span class="status-pill" [ngClass]="pwo.order.status">
                {{ pwo.order.status | titlecase }}
              </span>

              <!-- ACTION BUTTON -->
              <button
                class="actions-btn"
                (click)="toggleMenu(pwo.order.docId); $event.stopPropagation()"
                aria-label="Actions"
              >
                â‹®
              </button>

              <!-- CUSTOM DROPDOWN (Solution A) -->
              @if (activeMenuOrderId === pwo.order.docId) {
                <div class="work-order-menu" (click)="$event.stopPropagation()">
                  <button class="dropdown-item" (click)="openEditPanel(pwo.order)">Edit</button>

                  <button class="dropdown-item text-primary" (click)="onDelete(pwo.order)">
                    Delete
                  </button>
                </div>
              }
            </div>
          }
        </div>
      }
    </div>
  </div>

  <!-- ================= PANEL ================= -->
  @if (panelMode) {
    <!-- <div class="panel-backdrop" (click)="closePanel()"></div> -->

    <app-work-order-panel
      [mode]="panelMode"
      [order]="editingOrder"
      (save)="onPanelSave($event)"
      (cancel)="closePanel()"
    />
  }
</div>
